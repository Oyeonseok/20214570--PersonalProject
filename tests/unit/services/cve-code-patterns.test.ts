import { describe, it, expect } from 'vitest';
import {
  getPatternsByCve,
  getPatternsByPackage,
  getPatternsForCwe,
  scanCodeForCvePatterns,
  getAllCvePatterns,
} from '../../../src/services/cve-code-patterns.js';

describe('CVE Code Patterns', () => {
  it('getAllCvePatterns returns 20+ patterns', () => {
    const patterns = getAllCvePatterns();
    expect(patterns.length).toBeGreaterThanOrEqual(20);
  });

  it('getPatternsByCve finds lodash CVE', () => {
    const pattern = getPatternsByCve('CVE-2021-23337');
    expect(pattern).toBeDefined();
    expect(pattern!.packageName).toBe('lodash');
    expect(pattern!.cweId).toBe('CWE-77');
  });

  it('getPatternsByPackage finds multiple patterns for lodash', () => {
    const patterns = getPatternsByPackage('lodash');
    expect(patterns.length).toBeGreaterThanOrEqual(2);
  });

  it('getPatternsByPackage returns empty for unknown package', () => {
    expect(getPatternsByPackage('nonexistent-pkg')).toHaveLength(0);
  });

  it('getPatternsForCwe finds prototype pollution patterns', () => {
    const patterns = getPatternsForCwe('CWE-1321');
    expect(patterns.length).toBeGreaterThanOrEqual(2);
  });

  it('scanCodeForCvePatterns detects lodash template injection', () => {
    const code = `const tmpl = _.template(req.body.input);\ntmpl({ name: 'test' });`;
    const patterns = getPatternsByPackage('lodash');
    const findings = scanCodeForCvePatterns(code, patterns);
    expect(findings.length).toBeGreaterThan(0);
    expect(findings[0].cveId).toBe('CVE-2021-23337');
    expect(findings[0].line).toBe(1);
  });

  it('scanCodeForCvePatterns detects express open redirect', () => {
    const code = `app.get('/redirect', (req, res) => {\n  res.redirect(req.query.url);\n});`;
    const patterns = getPatternsByPackage('express');
    const findings = scanCodeForCvePatterns(code, patterns);
    expect(findings.length).toBeGreaterThan(0);
    expect(findings[0].cveId).toBe('CVE-2024-29041');
  });

  it('scanCodeForCvePatterns returns empty for safe code', () => {
    const code = `const x = 1 + 2;\nconsole.log(x);`;
    const patterns = getPatternsByPackage('lodash');
    const findings = scanCodeForCvePatterns(code, patterns);
    expect(findings).toHaveLength(0);
  });

  it('every pattern has required fields', () => {
    for (const p of getAllCvePatterns()) {
      expect(p.cveId).toMatch(/^CVE-/);
      expect(p.packageName).toBeTruthy();
      expect(p.cweId).toMatch(/^CWE-/);
      expect(p.dangerousPatterns.length).toBeGreaterThan(0);
      expect(p.codeRemediation).toBeTruthy();
      expect(p.codeRemediationKo).toBeTruthy();
      expect(p.safeAlternative).toBeTruthy();
      expect(p.references.length).toBeGreaterThan(0);
    }
  });
});
